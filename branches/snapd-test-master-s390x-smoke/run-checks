#!/bin/sh

if [ -z "$S390X_ENDPOINT" ]; then
	echo "S390X endpoint cannot be empty, exiting..."
	exit 1
fi

if [ -f s390x_key ]; then
	echo "S390X key file does not exist, exiting..."
	exit 1
fi

echo "Creating temporal directory"
TEMP_DIR=$(ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- mktemp -d)
echo "Temp dir created: $TEMP_DIR"

echo "Deploying remote executor"
scp -i s390x_key ./remote-executor "ubuntu@$S390X_ENDPOINT":"$TEMP_DIR"
echo "Showing deployed resources"
ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- ls -al "$TEMP_DIR"

echo "Executing tests"
ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- "$TEMP_DIR"/remote-executor

echo "Cleaning up the environment"
ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- rm -rf "$TEMP_DIR"

echo "Cleaning up spread and qemu instances"
ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- pkill spread
ssh -i s390x_key "ubuntu@$S390X_ENDPOINT" -- pkill qemu-system
